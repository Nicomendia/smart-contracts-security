const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("Ejercicio 6", function () {

  let deployer, atacante;

  beforeEach(async function () {

    [deployer, atacante] = await ethers.getSigners();

    // Se deploya el contrato
    const FlashLoanPool = await ethers.getContractFactory("FlashLoanPool", deployer);
    this.pool = await FlashLoanPool.deploy();

    // Se depositan 100 ETH en el contrato
    await this.pool.deposit({ value: ethers.utils.parseEther('100') });
    expect(
      await this.pool.balances(deployer.address)
    ).to.eq(ethers.utils.parseEther('100'));

    expect(
      await ethers.provider.getBalance(this.pool.address)
    ).to.eq(ethers.utils.parseEther('100'));  
  });

  it("Ataque", async function () {
    // COMPLETAR 
    // Desplegamos el contrato atacante
    const FlashLoanAttacker = await ethers.getContractFactory("FlashLoanAttacker", atacante);
    this.contratoAtacante = await FlashLoanAttacker.deploy(this.pool.address);

    let bal = await ethers.provider.getBalance(atacante.address);
    console.log("Balance inicial atacante: "+ethers.utils.formatEther(bal));
    
    await this.contratoAtacante.connect(atacante).attack();

    bal = await ethers.provider.getBalance(this.pool.address);
    console.log("Balance final ctto: "+bal);
    bal = await ethers.provider.getBalance(this.contratoAtacante.address);
    console.log("Balance final ctto atnte: "+bal);
    bal = await ethers.provider.getBalance(atacante.address);
    console.log("Balance final atacante: "+ethers.utils.formatEther(bal));
  });

  afterEach(async function() {
    expect(
      await ethers.provider.getBalance(this.pool.address)
    ).to.eq('0');
  });
});
